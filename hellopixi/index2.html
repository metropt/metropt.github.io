<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hello World</title>
</head>
<body id='pixiCanvas'>
  <script src="pixi.js"></script>
  <script src="https://d3js.org/d3.v4.js"></script>
  <script type="text/javascript">

    var myFunctionWasCalled = false;

    var app = new PIXI.Application(800, 600, {backgroundColor : 0x1099bb});
    document.body.appendChild(app.view);

    // Add the 'keydown' event listener to our document
    document.addEventListener('keydown', onKeyDown);

    // create a texture from an image path
    var texture_aim = PIXI.Texture.fromImage('alvo.png');
    var texture_aim_selected = PIXI.Texture.fromImage('alvo_selected.png');
    var texture_grid = PIXI.Texture.fromImage('grid.png');

    // Scale mode for pixelation
    texture_aim.baseTexture.scaleMode = PIXI.SCALE_MODES.NEAREST;
    texture_aim_selected.baseTexture.scaleMode = PIXI.SCALE_MODES.NEAREST;
    texture_grid.baseTexture.scaleMode = PIXI.SCALE_MODES.NEAREST;

    var grid = new PIXI.Sprite(texture_grid);
    var container_grid = new PIXI.Container();
    container_grid.addChild(grid);

    var container_aim = new PIXI.Container();

    for (var i = 0; i < 5; i++) {
        var aim = new PIXI.Sprite(texture_aim);
        aim.interactive = true;
        aim.buttonMode = true;
        aim.anchor.set(0.5);
        aim.scale.set(1);
        aim.dragging = false;
        aim.x = 50*(i+1);
        aim.y = 50;
        aim
            .on('pointerdown', onDragStart)
            .on('pointerup', onDragEnd)
            .on('pointerupoutside', onDragEnd)
            .on('pointermove', onDragMove);

        container_aim.addChild(aim);
    }

    var container_lines = new PIXI.Container();

    var line1 = new PIXI.Graphics();
    var line2 = new PIXI.Graphics();
    var angulo = new PIXI.Graphics();

    container_lines.addChild(line1);
    container_lines.addChild(line2);
    container_lines.addChild(angulo);

    var basicText = new PIXI.Text('Basic text in pixi');
    basicText.x = 0;
    basicText.y = 0;
    container_lines.addChild(basicText);

    container_grid.addChild(container_aim);
    container_grid.addChild(container_lines);

    app.stage.addChild(container_grid);
    grid.interactive = true;
    grid.on('pointerdown', teste);
    
    function teste(event) {
        var aim = new PIXI.Sprite(texture_aim);
        aim.interactive = true;
        aim.buttonMode = true;
        aim.anchor.set(0.5);
        aim.scale.set(1);
        aim.dragging = false;
        aim.x = event.data.getLocalPosition(this.parent).x;
        aim.y = event.data.getLocalPosition(this.parent).y;
        aim
            .on('pointerdown', onDragStart)
            .on('pointerup', onDragEnd)
            .on('pointerupoutside', onDragEnd)
            .on('pointermove', onDragMove);

        container_aim.addChild(aim);		
    }
		

    var zoom_handler = d3.zoom().scaleExtent([1, 5]).on("zoom", zoom_actions);

    function zoom_actions() {
        container_grid.scale.set(d3.event.transform.k)
        container_grid.position.set(d3.event.transform.x,d3.event.transform.y)
        for(var i = 0; i < container_aim.children.length; i++) {
           container_aim.children[i].scale.set(1/d3.event.transform.k);
         }

         line1.clear();
         line2.clear();
         angulo.clear();

         line1.lineStyle(2/d3.event.transform.k, 0xFFFFFF);
         line2.lineStyle(2/d3.event.transform.k, 0xFF00FF);
         angulo.lineStyle(2/d3.event.transform.k, 0xffffff);

         line1.moveTo(container_aim.children[1].x, container_aim.children[1].y);
         line1.lineTo(container_aim.children[2].x, container_aim.children[2].y);
         line2.moveTo(container_aim.children[2].x, container_aim.children[2].y);
         line2.lineTo(container_aim.children[3].x, container_aim.children[3].y);

         var ang1 = Math.atan2(container_aim.children[2].y - container_aim.children[1].y, container_aim.children[2].x - container_aim.children[1].x);
         var ang2 = Math.atan2(container_aim.children[3].y - container_aim.children[2].y, container_aim.children[3].x - container_aim.children[2].x);
         basicText.text = Math.round((ang2-ang1)*1000)/1000;
         angulo.arc(container_aim.children[2].x, container_aim.children[2].y, 20, 3.14+ang1,  ang2);

         basicText.scale.set(1/d3.event.transform.k);

    }

    var pixiCanvas = d3.select('#pixiCanvas');
    pixiCanvas.call(zoom_handler);

    function onDragStart(event) {
        pixiCanvas.on(".zoom", null);
        this.data = event.data;
        this.texture = texture_aim_selected;
        this.dragging = true;
    }

    function onDragEnd() {
        pixiCanvas.call(zoom_handler);
        this.texture = texture_aim;
        this.dragging = false;
        this.data = null;
    }

    function onDragMove() {
        if (this.dragging) {
            this.position = this.data.getLocalPosition(this.parent);

            line1.clear();
            line2.clear();
            angulo.clear();

            line1.lineStyle(2, 0xFFFFFF);
            line2.lineStyle(2, 0xFF00FF);
            angulo.lineStyle(2, 0xffffff);

            line1.moveTo(container_aim.children[1].x, container_aim.children[1].y);
            line1.lineTo(container_aim.children[2].x, container_aim.children[2].y);
            line2.moveTo(container_aim.children[2].x, container_aim.children[2].y);
            line2.lineTo(container_aim.children[3].x, container_aim.children[3].y);

            var ang1 = Math.atan2(container_aim.children[2].y - container_aim.children[1].y, container_aim.children[2].x - container_aim.children[1].x);
            var ang2 = Math.atan2(container_aim.children[3].y - container_aim.children[2].y, container_aim.children[3].x - container_aim.children[2].x);
            basicText.text = Math.round((ang2-ang1)*1000)/1000;
            angulo.arc(container_aim.children[2].x, container_aim.children[2].y, 20, 3.14+ang1,  ang2);
            //console.log(Math.atan2(container_aim.children[2].y - container_aim.children[3].y, container_aim.children[2].x - container_aim.children[3].x));
        }
    }

    function onKeyDown(key) {
        if (key.keyCode === 65 || key.keyCode === 37) {
            pixiCanvas.call(zoom_handler.transform, d3.zoomIdentity);
        }
    }

  </script>
  <div id="root">
  </div>
  <script type="text/javascript" src="/static/js/main.b5153246.js">
  </script>
</body>
</html>
