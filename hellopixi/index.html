<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hello World</title>
</head>
<body id='pixiCanvas'>
  <script src="pixi.js"></script>
  <script src="https://d3js.org/d3.v4.js"></script>
  <script type="text/javascript">


    var app = new PIXI.Application(800, 600, {backgroundColor : 0x1099bb});
    document.body.appendChild(app.view);

    // Add the 'keydown' event listener to our document
    document.addEventListener('keydown', onKeyDown);

    // create a texture from an image path
    var texture_aim = PIXI.Texture.fromImage('alvo.png');
    var texture_aim_selected = PIXI.Texture.fromImage('alvo_selected.png');
    var texture_grid = PIXI.Texture.fromImage('grid.png');

    // Scale mode for pixelation
    texture_aim.baseTexture.scaleMode = PIXI.SCALE_MODES.NEAREST;
    texture_aim_selected.baseTexture.scaleMode = PIXI.SCALE_MODES.NEAREST;
    texture_grid.baseTexture.scaleMode = PIXI.SCALE_MODES.NEAREST;

    var grid = new PIXI.Sprite(texture_grid);
    app.stage.addChild(grid);

    var aim = new PIXI.Sprite(texture_aim);
    aim.interactive = true;
    aim.buttonMode = true;
    aim.anchor.set(0.5);
    aim.scale.set(1);
    aim.real_x = 0;
    aim.real_y = 0;
    aim.dragging = false;
    aim.x = 0;
    aim.y = 0;
    aim
        .on('pointerdown', onDragStart)
        .on('pointerup', onDragEnd)
        .on('pointerupoutside', onDragEnd)
        .on('pointermove', onDragMove);
    app.stage.addChild(aim);

    var aim2 = new PIXI.Sprite(texture_aim);
    aim2.interactive = true;
    aim2.buttonMode = true;
    aim2.anchor.set(0.5);
    aim2.scale.set(1);
    aim2.real_x = 0;
    aim2.real_y = 0;
    aim2.dragging = false;
    aim2.x = 0;
    aim2.y = 0;
    aim2
        .on('pointerdown', onDragStart)
        .on('pointerup', onDragEnd)
        .on('pointerupoutside', onDragEnd)
        .on('pointermove', onDragMove);
    app.stage.addChild(aim2);

    var zoom_handler = d3.zoom().scaleExtent([1, 5]).on("zoom", zoom_actions);
    
    function zoom_actions() {
        grid.scale.set(d3.event.transform.k)
        grid.position.set(d3.event.transform.x,d3.event.transform.y)
        aim.position.set(
            (grid.getGlobalPosition().x)+(aim.real_x*d3.event.transform.k),
            (grid.getGlobalPosition().y)+(aim.real_y*d3.event.transform.k))
    }

    var pixiCanvas = d3.select('#pixiCanvas');
    pixiCanvas.call(zoom_handler);

    function onDragStart(event) {
        pixiCanvas.on(".zoom", null);
        this.data = event.data;
        this.texture = texture_aim_selected;
        this.dragging = true;
    }

    function onDragEnd() {
        pixiCanvas.call(zoom_handler);
        this.texture = texture_aim;
        this.dragging = false;
        this.data = null;
    }

    function onDragMove() {
        if (this.dragging) {
            var new_position = this.data.getLocalPosition(this.parent);
            this.real_x += (new_position.x-this.x)/grid.scale.x
            this.x = new_position.x
            this.real_y += (new_position.y-this.y)/grid.scale.y
            this.y = new_position.y
        }
    }

    function onKeyDown(key) {
        if (key.keyCode === 65 || key.keyCode === 37) {
            pixiCanvas.call(zoom_handler.transform, d3.zoomIdentity);
        }
    }

  </script>
</body>
</html>